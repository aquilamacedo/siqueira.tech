---
layout: post
title: "kw deploy: handling the installation of new Kernel"
date: 2019-11-24
published: true
categories: "linux-kernel-basic"
---

The most common task when we develop for Linux Kernel, it is the installation of a new kernel image for later test. This page will give an overview on how kw manage this task.

# Overview

When we work in a bug fix or the implementation of a new feature in the Kernel, we have to test it somehow. The most common way to test your work consist by create a new Kernel and module binaries, and install it in a test machine that could be an extra machine, a virtual machine, or your host computer. As can be seen in the page NOME_COM_LINK, the installation of a new kernel requires multiple steps and after you learn it becomes a really boring tasks. Additionally, if you work with different kernel targets you have to customize the installation steps a little bit for each distribution.

For all of this reasons, we decided to implement a feature in kw named **deploy**. This component have the mission of make easy to install new Kernel version in a target machine and make it in a flexible way that we can support multiple distros.

**Attention:**
Deploy feature rely in the Linux kernel repository, for this reason you have to execute this command inside of the Kernel repository.
{: .warning}

# Commands

For the deploy option, we have a small set of options which can be summarized below:

```
deploy,d --remote [REMOTE:PORT] [--reboot|-r] [--modules|-m]
deploy,d --local [--reboot|-r] [--modules|-m]
deploy,d --vm [--reboot|-r] [--modules|-m]
```

The deploy option can be invoke as `kw deploy` or just `kw d`, it also have two option that are common for all the operations:

* `--modules`: If you add this option, you will instruct `kw` to only deploy modules. In other words, this command will only copy the modules files to the target machine;
* `--reboot`: This option reboot the target machine after the deploy installation finish.

It is important to highlight that you can customize the `kw deploy` behaviour by change the available options in the `kworkflow.config`. We have:

* `default_deploy_target`: If you don't want to type `--remote, --local, --vm` every time that you deploy a command, you can specify your preferred option in this parameter. For example, `default_deploy_target=remote`.
* `reboot_after_deploy`: If you always want to reboot the machine after you execute the deploy command, you can add `yes` for this option. Otherwise, just add `no`.

Now, let's take a detailed view of each target for deploy supported by `kw`.

## Remote

This option is the most generic ones related to deploy a new machine and can be used for all sort of target (remote, vm, and local) because it uses network to deploy any new Kernel. For example, if you have a way to connect to your virtual machine by using ssh you can deploy to it with the remote option. Also, if you use the localhost you can deploy a new kernel to your host machine.

The remote options imply the superuser permission in the target machine since you will install a new kernel. With this idea in mind `kw` profit from this by using the `/root` directory for storing a temporary files that going to be used for update the target machine, we create the following directory in the remote machine:

*

For deploy the correct files without pollute your workspace, `kw` creates a directory at `~/kw` with the following subdirectories:

* `remote`: this directory work as a temporary place, for putting the latest kernel modules. It basically maintain the files generated by `make modules_install`;
* `to_deploy`: here we keep a `tar.gz` file that contains the kernel image, modules and other files required for install a new kernel image.

With all of this idea in mind, suppose that you have an remote machine available and you want to deploy a new kernel image; you just need to use:

```
kw deploy --remote IP:PORT # e.g., kw d --remote 172.16.254.1:22
```

Type the above command can be tedious, however, you can specify your current work scenario by simply change `kworkflow.config` as the example below illustrates:

```
ssh_ip=172.16.254.1
ssh_port=22
...
default_deploy_target=remote
reboot_after_deploy=no
```

After change the `kworkflow.config` as described above, you just need to use:

```
kw deploy # kw d
```

Take a look at the available option in the `kworkflow.config`.

## VM

`kw` originally born to be used with QEMU vms, for this reason the deploy option has the option `--vm` dedicated to handle virtual machine. The way that kw handles a VM it is based on libguestfs which is used for mount a QEMU image in a filesystem and after that operate over the mounted directory. Before start to use this option, take a look at `kworkflow.config` and change the following options:

```
mount_point=/home/USERKW/p/mount
qemu_path_image=/home/USERKW/p/virty.qcow2
```

* `mount_point`: Specifies the target directory for building the QEMU image;
* `qemu_path_image`: Specify the path to the QEMU image.

After you specify the above parameters, you are ready for deploy a new kernel module in the VM. With your VM turned out, you can use:

```
kw deploy --vm
```

This command will mount the QEMU image in the specified path, and after that it will install a new set of modules in the VM. After the process finish, you can turn-on the VM and see the change.

**Attention:**
Unfortunately, `kw deploy --vm` does not deploy a new kernel image, for more information about it take a look at: [Deploy new Kernel image for QEMU VM with libguestfs](https://github.com/kworkflow/kworkflow/issues/139). However, you can use `kw deploy --remote` for overcome this issue.
{: .warning}

## Local

Another feature that `kw deploy` support it is the support for installing a new Kernel in your host machine. Suppose that you want to install the latest version of the Linux kernel in your Arch/Debian/Ubuntu system, you just need to use:

```
kw deploy --local
```
**Attention:**
This operation requires a super user privileges, for this reason double-check your steps.
{: .danger}

# Conclusion

In this page we covered the use of the `deploy` option in three different scenarios. Keep in mind that we have a lot of work to do in this part of the code, we want to make this feature more generic and customizable; if you like it, help us to improve `kw`. We have a lot of open issues in our repository.

For the next post related with `kw` I want to discuss about the source in order to encourage people to help us to make `kw` better.
